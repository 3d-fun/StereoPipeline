\chapter{Programs}

This chapter covers the various user-programs that are a part of
the Ames Stereo Pipeline.

\section{stereo}
\label{stereo}

The \texttt{stereo} program is the primary workhorse of the Ames
Stereo Pipeline.  It is the program that takes a pair of images which
overlap and creates an output point cloud which can then be fed to the
\texttt{point2mesh} or \texttt{point2dem} programs.

\medskip

Usage:
\begin{verbatim}
    stereo [options] <Left_input_image> <Right_input_image> \\
           [Left_camera_file] [Right_camera_file] <output_file_prefix>
\end{verbatim}

\medskip

In principal, the stereo program is very simple, it takes two input
images (and their optional camera files) and creates a bevy of
output files.

\emph{MJB: fact check this para.}
The \verb=<Left_input_image>= and \verb=<Right_input_image>= files can be a wide variety of image formats.  If your input image files contain camera information (e.g. ISIS \verb=.cub= files), then the \verb=Left_camera_file= and \verb=Right_camera_file= are optional.

\emph{MJB: detail the format of the camera\_files if people need them.}

The \verb=<output_file_prefix>= is what \verb=stereo= uses as the
beginning part of most of the files that it writes out.  If you set
\verb=<output_file_prefix>= to be `\verb=out=' then files will be
named \verb=out-L.tif= and  \verb=out-PC.tif=.  If you use something
like `\verb=out/out=' for \verb=<output_file_prefix>= then the
\verb=stereo= program will create a directory called \verb=out/= and
place files named \verb=out-L.tif=, \verb=out-PC.tif=, etc. into
that directory, which can sometimes be handy.

The files that \verb=stereo= creates are as follows (assuming \verb=<output_file_prefix>= is set to be `\verb=out=' although it need not be):

\emph{MJB: detail all of these.}

\begin{description}

\item[.vwip] 
One of these Vision Workbench Interest Point files will be created
for each input image. If your images are \texttt{left.cub}
and \texttt{right.cub} you'll get \texttt{left.vwip} and
\texttt{right.vwip}. The \texttt{.vwip} file is an intermediate
file that highlights unique points in an image. They are created
with the default settings of \texttt{ipfind} from the Vision
Workbench.

\item[.match] 
The match file lists a select group of unique points out of the 
previous \texttt{.vwip} files that have been properly identified 
in both images. This match file is used to calculate the intial 
overlap of the images if \texttt{DO\_INTERESTPOINT\_ALIGNMENT} has 
been set.  \emph{Again, if your images are \texttt{left.cub} and 
\texttt{right.cub} you'll get a \texttt{left\_\_right.match} file.}

The \texttt{.vwip} and \texttt{.match} files will 
only be created if \texttt{DO\_INTERESTPOINT\_ALIGNMENT}
has been set.  These files can help speed up the process while you
fool around with parameters in your \texttt{stereo.default} file,
since their contents are not affected by other parameters.  If these
files exist, then the \texttt{stereo} program will skip over the
interest point alignment stage and just use these files.  So if you
run \texttt{stereo} on the same pair of images more than once, don't
delete these files, take advantage of them.  Of course, if you do,
\texttt{stereo} will just rebuild them.  Also, you don't have to
worry about these files being `bad' since their contents aren't
affected by changes to the \texttt{stereo.default} file.  In the
rare case that one of these files did get corrupted, you would get
a `failed to read interest point file' error message from
\texttt{stereo}.

\item[out-L.tif]
Left image in the stereo pair (mostly identical to input).

\item[out-R.tif]
Right (ailgned) image of the stereo pair.

\item[out-lMask.tif] Image mask for the left image.
\item[out-rMask.tif] Image mask for the right image.

\item[out-align.exr] Alignment.  The linear affine transformation
that results from interest point alignment.  If
\texttt{DO\_INTERESTPOINT\_ALIGNMENT} is off in the \texttt{stereo.default}
file, then this file won't get made.

\item[out-D.exr] 
This is the unfiltered disparity map, straight out of the integer
pixel correlator.  Contains only integer values of disparity.

\item[out-R.exr] Disparity map after sub-pixel refinement.

\item[out-F-corrected.exr]
Only created when \texttt{DO\_INTERESTPOINT\_ALIGNMENT} is on.
Disparity map with effects of interest point alignment removed.
Intermediate data product.

\item[out-F.exr]
The Filtered, sub-pixel disparity map with outlier removal and holes
filled in (only exists if \texttt{FILL\_HOLES\_NURBS} is on).

\item[out-GoodPixelMap.tif]
An image showing which pixels were matched by the stereo correlator,
and which were filled in by the hole filling algorithm.

\item[out-PC.tif]
Point Cloud image with 3D locations for each point.  Stored as a
64 bit, 3 channel TIFF, with coordinates in body-fixed planetocentric
coordinate system.  Odds are good that your usual TIFF viewer
programs will not visualize this file properly.  This file should
really be considered a `data' file, not an `image' file.  Other
programs in the Stereo Pipeline will convert the contents of this
file to more easily vizualized formats.

\item[out-stereo.default] This is a copy of the \texttt{stereo.default} file
  used during the run of \texttt{stereo} that built all of these
  files.


\end{description}



\subsection{Options}

\begin{verbatim}
  -h [ --help ]                                Display this help message
  --cache arg (=1800)                          Cache size, in megabytes
  --threads arg (=0)                           Select the number of processors 
                                               (threads) to use.
  -t [ --session-type ] arg                    Select the stereo session type 
                                               to use for processing. [options:
                                               pinhole isis]
  -s [ --stereo-file ] arg (=./stereo.default) Explicitly specify the 
                                               stereo.default file to use. 
                                               [default: ./stereo.default]
  -e [ --entry-point ] arg (=0)                Pipeline Entry Point (an integer
                                               from 1-4)
  -d [ --debug-level ] arg (=29)               Set the debugging output level. 
                                               (0-50+)
  --crop-min-x arg                             Crop the aligned input images to
                                               these bounds ( <min_x> <min_y> 
                                               <width> <height> ) prior to 
                                               running through the correlator. 
                                               Useful for tuning settings 
                                               before processing the whole 
                                               image.
  --crop-min-y arg
  --crop-width arg
  --crop-height arg
  --draft-mode arg                             Cause the pyramid correlator to 
                                               save out debug imagery named 
                                               with this prefix.
  --optimized-correlator                       Use the optimized correlator 
                                               instead of the pyramid 
                                               correlator.
\end{verbatim}

\subsection{Entry Points}
\label{entrypoints}

\emph{MJB: discuss the different phases, and how to know when you're
in which, etc.}

Stage 0 (Preprocessing) normalizes the two images and aligns them
(thus non-projected images are easier to work with) by locating
interest points and matching them in both images. The program is
designed to reject outlying interest points.  This stage writes out
the pre-aligned images and the image masks.

Stage 1 (Correlation) performs the image correlation and the building
of a disparity map.

Stage 2 (Refinement) performs sub-pixel correlation which further
refines the solution.

Stage 3 (Filtering) performs filtering of the disparity map and
creates a ``good pixel'' map.  If enabled, this is also the step
where holes are filled in.

Stage 4 (Triangulation). The disparity map is processed to remove
the effects of interest point alignment and a 3D point cloud is
created.


\subsection{stereo.default file}
\label{stereo.default}

The \texttt{stereo.default} file contains configuration parameters
which the \texttt{stereo} program uses to process the images.  Below
we will walk through the contents of the \texttt{stereo.default.example}
file distributed with the Ames Stereo Pipeline and discuss all of
the various parameters.

The parameters which begin with `\texttt{DO\_}' are true/false options,
when set to `1' they are `on' or `true,' and if set to `0' they are
`off' or `false.'

The parameters below also have their default values listed after
the parameter name.

\subsubsection*{Preprocessing}
\hrule
\bigskip

\begin{description}
\item[DO\_INTERESTPOINT\_ALIGNMENT 1] \hfill \\ When
  \texttt{DO\_INTERESTPOINT\_ALIGNMENT} is on (or set to 1),
  \texttt{stereo} will perform \texttt{ipfind} and \texttt{ipmatch} to
  generate a \texttt{.match} file that list interesting points that
  can be found in both images. From this \texttt{.match} file the
  overlap of the images can be calculated and the right image is
  transformed respectively. This alignment is performed with the
  default settings for \texttt{ipfind} and \texttt{ipmatch}. If these
  results are found unsatisfactory the user can calculate
  \texttt{.vwip} or \texttt{.match} files before hand using whatever
  tools deemed 'best', just be sure to keep naming conventions the
  same as what \texttt{stereo} produces. An extreme alternative is
  described in the appendix (page \pageref{appendix_surf}).

\item[DO\_EPIPOLAR\_ALIGNMENT 0] \hfill \\ By default this is off.
  When on, epipolar alignment is the alternative to interest point
  alignment. This means instead of using interest points to calculate
  the initial overlap, the inherent underlining geometry of the
  cameras that took the images are used. This option is unfortunately
  limited in use only to stereo sessions that provide pinhole camera
  models.

\item[INTERESTPOINT\_ALIGNMENT\_SUBSAMPLING 1] \hfill \\
This option allows you to change the density of interest points
that stereo will find, correlate, and result in the final point
cloud.  When this is set to 1, there is no subsampling, the
\texttt{stereo} program will do its best to find as many interest
points within the imagery as it can.  When this is set to 2, the
program will ignore every other interest point that it finds, and
will only process the reduced set.  This parameter can be set to
any positive integer.  When this parameter is turned up, the resulting
point cloud will have less effective resolution.

\item[DO\_SLOG 1]
\item[DO\_LOG 0] \hfill \\
These two items are related, only one can be set to `on', if both
are `on' the program will default to doing only SLOG.  \emph{MJB: explain the difference}

\item[SLOG\_KERNEL\_WIDTH 1.5] \hfill \\
When \texttt{DO\_SLOG} is `on,' this option sets the diameter of
the convolution kernel. \emph{MJB: describe}

\end{description}

\subsubsection*{Correlation}
\hrule
\bigskip

\begin{description}
\item[H\_KERNEL 25]
\item[V\_KERNEL 25] \hfill \\
These two items determine the size of the kernel in the horizontal (H) and vertical (V) directions in the input images.  \emph{MJB: more detail}

\item[SUBPIXEL\_H\_KERNEL 25]
\item[SUBPIXEL\_V\_KERNEL 25] \hfill \\
These two items are only relevant when the \texttt{DO\_H\_SUBPIXEL} and \texttt{DO\_V\_SUBPIXEL} parameters (detailed below) are `on.'  They speciffy the size of the subpixel kernel in the horizontal (H) and vertical (V) directions.

\item[H\_CORR\_MIN -100]
\item[H\_CORR\_MAX 100]
\item[V\_CORR\_MIN -100]
\item[V\_CORR\_MAX 100] \hfill \\
These parameters determine the size of the correlation window that the kernel will be moved around within to find a match.

\item[SUBPIXEL\_MODE 0] \hfill \\
This parameter determines the method by which subpixel correlation is done:
\emph{AN: describe}
	\begin{description}
	\item[0 - parabola fitting (fastest)]
	\item[1 - affine adaptive window, robust weighting (slow!)]
	\item[2 - affine adaptive window, bayes weighting (slow!)]
	\end{description}

\item[DO\_H\_SUBPIXEL 1]
\item[DO\_V\_SUBPIXEL 1] \hfill \\
These parameters turn `on' and `off' the subpixel correlation
algorithms.  For the most part, you almost always want these `on.'

\item[XCORR\_THRESHOLD 2.0] \hfill \\
This cross-correlation threshold determines ... \emph{MJB: describe}

\item[CORRSCORE\_REJECTION\_THRESHOLD 1.1] \hfill \\
\emph{MJB: describe}

\item[COST\_BLUR 0] \hfill \\
Turn this up to improve the results of the discrete
correlation step.  This will reduce the number of 
missing pixels, but will reduce the overall accuracy of 
the disparity estimates.  It is best used in conjuction with 
affine adaptive window subpixel modes above.

\item[COST\_MODE 0] \hfill \\
This allows you to select a cost function type:
\emph{AN: describe}
	\begin{description}
	\item[0 - absolute difference]
	\item[1 - squared difference]
	\item[2 - normalized cross correlation]
	\end{description}

\end{description}

\subsubsection*{Filtering}
\hrule
\bigskip

\begin{description}

\item[FILL\_HOLES\_NURBS 1] \hfill \\
When this is `on' the holes in the point cloud (which are a result of poor matching) will be filled by a Nonuniform rational B-spline (NURBS) which should do a pretty good job of hiding the holes.

\item[RM\_H\_HALF\_KERN 5]
\item[RM\_V\_HALF\_KERN 5] \hfill \\
These two parameters determine the size of the half kernel which
is used to perform the automatic removal of low confidence pixels.
So a $5 \times 5$ half kernel would result in an $11 \times 11$
kernel with 121 pixels in it.

\item[RM\_MIN\_MATCHES 60]
\emph{MJB: detail.  stereo.default comment says `Units = percest'  should that be `percent?'}

\item[RM\_TRESHOLD 3]
\emph{MJB: detail}

\end{description}


\subsubsection*{Dot Cloud}
\hrule
\bigskip

\begin{description}
\item[NEAR\_UNIVERSE\_RADIUS 0.0]
\item[FAR\_UNIVERSE\_RADIUS 0.0] \hfill \\
These parameters set the size of the dot cloud's `universe' in meters and altitude off the ground.  Setting both to zero turns off this restriction and allows the dot cloud to be as big as the data allows for. \emph{MJB: I extemporized this, please correct.}

\end{description}

\section{disparitydebug}
\label{disparitydebug}

Performs half of the stereo correlation and output data. Good for
determine the search window reference in stereo.default.

This program creates files named p19-[D,F]-[H,V].tif what do they contain?

\section{point2mesh}
\label{point2mesh}

Produces a mesh surface which can be visualized in OpenSceneGraph.

Example:
\begin{verbatim}
point2mesh
\end{verbatim}

\section{point2dem}
\label{point2dem}

Produces a GeoTIFF terrain model and orthographic image.

This produces: 
	p19-DEM.tif - A DEM with floating point pixels. This is suitable for use in a GIS.
	p19-DEM-normalized.tif - A version of the DEM where the heights have been mapped onto the range 0-255 so that it can be viewed in a normal image viewer.

Example:
\begin{verbatim}
point2dem filename-PC.tif -o stereo/filename --xyz -r moon \\
        --default-value -10000
\end{verbatim}

\section{hillshade}
\label{hillshade}

Example:
\begin{verbatim}
hillshade filename-DEM.tif -o stereo/filename --nodata-value -10000
\end{verbatim}

\section{colormap}
\label{colormap}

Example:
\begin{verbatim}
colormap filename-DEM.tif --shaded-relief filename-shaded.tif \\
        --nodata -10000 -min -8900 --max 8000 -o filename-shaded-colormap.tif
\end{verbatim}

\section{orthoproject}
\label{orthoproject}

Example:
\begin{verbatim}
orthoproject -t isis filename-DEM.tif filename.cub filename.isis_adjust \\
        filename-DRG.tif --nodata -10000 --ppd 256
\end{verbatim}
